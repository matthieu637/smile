#!/bin/bash

EXEC="../build/stest"
DATA="../data"

. job_pool.sh
. extract.sh

if [ $# -eq 1 ]; then
	CPU=$1
else
	. cpu.sh
	CPU=$(nbcpu)
fi

if [ ! -e $DATA ] ; then
	echo "create data dir"
	mkdir $DATA
	mkdir $DATA/graphs
fi

if [ ! -e $EXEC ] ; then
	echo "cannot find executable"
	exit 1
fi

# 1 : TEST
# 2 : FUSION (1 -> yes)
# 3 : NB TEST
function launch_test(){

job_pool_init $CPU 0
echo "start a pool of $CPU thread"

TEST=$1
fusion=$2
nbtest=$3

test_nospace=`echo $TEST | sed -e 's/ /_/g'`

for i in $(seq 1 1 ${nbtest})
do
	job_pool_run "$EXEC $TEST > $DATA/$test_nospace.$i 2>&1"
	./usleep 10000
done

job_pool_wait
job_pool_shutdown

if [ $fusion -eq 1 ] ; then
	cat $DATA/$test_nospace.* > $DATA/$test_nospace
	rm $DATA/$test_nospace.*

	extract_data $DATA/$test_nospace
fi

}


# # # #car
# launch_test "FMS3T 300" 1 300
# launch_test "FMQ3T 300" 1 300
# launch_test "FMS3_ 300" 1 300
# launch_test "FMQ3_ 300" 1 300
# 
# # S3T
# launch_test "TBMS3TIEA 300 100" 1 100
# launch_test "TBMS3TIIA 300 100" 1 100
# launch_test "TBMS3TIMC 300 100" 1 100
# # S3_
# launch_test "TBMS3_IEA 300 100" 1 100
# launch_test "TBMS3_IIA 300 100" 1 100
# launch_test "TBMS3_IMC 300 100" 1 100
# 
# # Q3T
# launch_test "TBMQ3TIEA 300 100" 1 100
# launch_test "TBMQ3TIIA 300 100" 1 100
# launch_test "TBMQ3TIMC 300 100" 1 100
# # Q3_
# launch_test "TBMQ3_IEA 300 100" 1 100
# launch_test "TBMQ3_IIA 300 100" 1 100
# launch_test "TBMQ3_IMC 300 100" 1 100



# # #grid
# launch_test "FGS3T 200" 1 200
# launch_test "FGQ3T 200" 1 200
# launch_test "FGS3_ 200" 1 200
# launch_test "FGQ3_ 200" 1 200
# 
# # S3T
# launch_test "TBGS3TIEA 200 150" 1 100
# launch_test "TBGS3TIIA 200 150" 1 100
# launch_test "TBGS3TIMC 200 150" 1 100
# S3_
# launch_test "TBGS3_IEA 200 150" 1 100
launch_test "TBGS3_IIA 200 150" 1 100
launch_test "TBGS3_IMC 200 150" 1 100
# 
# # Q3T
# launch_test "TBGQ3TIEA 200 150" 1 100
# launch_test "TBGQ3TIIA 200 150" 1 100
# launch_test "TBGQ3TIMC 200 150" 1 100
# Q3_
# launch_test "TBGQ3_IEA 200 150" 1 100
# launch_test "TBGQ3_IIA 200 150" 1 100
# launch_test "TBGQ3_IMC 200 150" 1 100




# k=".001"
# incr=".001"
# end=".04"
# 
# while [ `echo "$k <= $end" | bc` -eq 1 ]
# do
# 	echo $k
# 	launch_test "mcar_qltable_teacher_annonce $k" 1
# 	k=`echo $k + $incr | bc`
# done

