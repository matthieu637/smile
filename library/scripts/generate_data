#!/bin/bash

EXEC="../build/stest"
DATA="../data"

. job_pool.sh

if [ $# -eq 1 ]; then
	CPU=$1
else
	. cpu.sh
	CPU=$(nbcpu)
fi

if [ ! -e $DATA ] ; then
	echo "create data dir"
	mkdir $DATA
	mkdir $DATA/graphs
fi

if [ ! -e $EXEC ] ; then
	echo "cannot find executable"
	exit 1
fi

# 1 : TEST
# 2 : FUSION (1 -> yes)
# 3 : NB TEST
function launch_test(){

job_pool_init $CPU 0
echo "start a pool of $CPU thread"

TEST=$1
fusion=$2
nbtest=$3

test_nospace=`echo $TEST | sed -e 's/ /_/g'`

for i in $(seq 1 1 ${nbtest})
do
	job_pool_run "$EXEC $TEST > $DATA/$test_nospace.$i 2>&1"
	./usleep 10000
done

job_pool_wait
job_pool_shutdown

if [ $fusion -eq 1 ] ; then
	cat $DATA/$test_nospace.* > $DATA/$test_nospace
	rm $DATA/$test_nospace.*
fi

}

nbrTest=5

#graphA1
launch_test "TMQ1Q1AMTB" 1 $nbrTest
launch_test "TMQ1Q1AOTB" 1 $nbrTest
launch_test "TMQ1Q1ANTB" 1 $nbrTest
launch_test "TMQ1Q1AITB" 1 $nbrTest

launch_test "TMQ1Q1AMTA" 1 $nbrTest
launch_test "TMQ1Q1AOTA" 1 $nbrTest
launch_test "TMQ1Q1ANTA" 1 $nbrTest
launch_test "TMQ1Q1AITA" 1 $nbrTest


# k=".001"
# incr=".001"
# end=".04"
# 
# #while [ `echo "$k <= $end" | bc` -eq 1 ]
# #do
# #	echo $k
# #	launch_test "mcar_qltable_teacher $k" 1
# #	k=`echo $k + $incr | bc`
# #done
# 
# 
# while [ `echo "$k <= $end" | bc` -eq 1 ]
# do
# 	echo $k
# 	launch_test "mcar_qltable_teacher_annonce $k" 1
# 	k=`echo $k + $incr | bc`
# done

