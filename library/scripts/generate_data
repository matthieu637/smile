#!/bin/bash

EXEC="../build/stest"
DATA="../data"

. job_pool.sh
. extract.sh

if [ $# -eq 1 ]; then
	CPU=$1
else
	. cpu.sh
	CPU=$(nbcpu)
fi

if [ ! -e $DATA ] ; then
	echo "create data dir"
	mkdir $DATA
	mkdir $DATA/graphs
fi

if [ ! -e $EXEC ] ; then
	echo "cannot find executable"
	exit 1
fi

# 1 : TEST
# 2 : FUSION (1 -> yes)
# 3 : NB TEST
function launch_test(){

job_pool_init $CPU 0
echo "start a pool of $CPU thread"

TEST=$1
fusion=$2
nbtest=$3

test_nospace=`echo $TEST | sed -e 's/ /_/g'`

for i in $(seq 1 1 ${nbtest})
do
	job_pool_run "$EXEC $TEST > $DATA/$test_nospace.$i 2>&1"
	./usleep 10000
done

job_pool_wait
job_pool_shutdown

if [ $fusion -eq 1 ] ; then
	cat $DATA/$test_nospace.* > $DATA/$test_nospace
	rm $DATA/$test_nospace.*

	extract_data $DATA/$test_nospace
fi

}

# # #grid
# launch_test "FG 200 0" 1 3000
# launch_test "TBGEA 200 0 150" 1 1000
# launch_test "TBGIA 200 0 150" 1 1000
# launch_test "TBGMC 200 0 150" 1 1000
# 
# launch_test "FG 200 1" 1 3000
# launch_test "TBGEA 200 1 150" 1 1000
# launch_test "TBGIA 200 1 150" 1 1000
# launch_test "TBGMC 200 1 150" 1 1000
# 
# 
# # #car
#launch_test "FM 600 0" 1 100
#launch_test "FM 600 1" 1 100

launch_test "FM 300 0" 1 300
launch_test "TBMEA 300 0 150" 1 100
launch_test "TBMIA 300 0 150" 1 100
launch_test "TBMMC 300 0 150" 1 100

launch_test "FM 300 1" 1 300
launch_test "TBMEA 300 1 150" 1 100
launch_test "TBMIA 300 1 150" 1 100
launch_test "TBMMC 300 1 150" 1 100


# launch_test "TBMPP 100 0 500 M" 1 300
# launch_test "TBMPP 100 0 500 I" 1 300

# launch_test "TBMPP 100 1 500 M" 1 300
# launch_test "TBMPP 100 1 500 I" 1 300

# launch_test "FM 1000 0" 1 1000
# launch_test "TBMPP 1000 0 500 M" 1 1000
# launch_test "TBMPP 1000 0 500 I" 1 1000

# k=".001"
# incr=".001"
# end=".04"
# 
# #while [ `echo "$k <= $end" | bc` -eq 1 ]
# #do
# #	echo $k
# #	launch_test "mcar_qltable_teacher $k" 1
# #	k=`echo $k + $incr | bc`
# #done
# 
# 
# while [ `echo "$k <= $end" | bc` -eq 1 ]
# do
# 	echo $k
# 	launch_test "mcar_qltable_teacher_annonce $k" 1
# 	k=`echo $k + $incr | bc`
# done

